<canvas data-three-sphere class="absolute inset-0 w-full h-full block"></canvas>

<script>
    import * as THREE from "three";
    import { FBXLoader } from "three/examples/jsm/loaders/FBXLoader.js";
    import { RoomEnvironment } from "three/examples/jsm/environments/RoomEnvironment.js";

    const canvas = document.querySelector("[data-three-sphere]");

    if (canvas) {
        const renderer = new THREE.WebGLRenderer({
            canvas,
            antialias: true,
            alpha: true,
        });
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        renderer.toneMapping = THREE.ACESFilmicToneMapping;
        renderer.toneMappingExposure = 1.25;

        const scene = new THREE.Scene();

        const pmremGenerator = new THREE.PMREMGenerator(renderer);
        pmremGenerator.compileEquirectangularShader();
        const roomEnvironment = new RoomEnvironment();
        scene.environment = pmremGenerator.fromScene(
            roomEnvironment,
            0.02,
        ).texture;
        roomEnvironment.dispose();

        const camera = new THREE.PerspectiveCamera(45, 1, 0.1, 100);
        camera.position.set(0, 0.6, 0);
        camera.lookAt(0, 0.55, 0);

        // const light1 = new THREE.DirectionalLight(0xffffff, 3.0);
        // light1.position.set(5, 5, 5);
        // scene.add(light1);

        // const light2 = new THREE.DirectionalLight(0xffffff, 2.0);
        // light2.position.set(-5, 5, 2);
        // scene.add(light2);

        const ambient = new THREE.AmbientLight(0xffffff, 0.3);
        scene.add(ambient);

        const diamondMaterial = new THREE.MeshPhysicalMaterial({
            color: 0x3a51a3,
            metalness: 0.1,
            roughness: 1,
            transmission: 0,
            thickness: 1,
            envMapIntensity: 1,
            clearcoat: 1.0,
            clearcoatRoughness: 0,
            ior: 1,
            dispersion: 1,
            attenuationColor: new THREE.Color(0x0099ff),
            attenuationDistance: 0.8,
            specularIntensity: 1.0,
            specularColor: new THREE.Color(0xffffff),
            side: THREE.DoubleSide,
        });

        const pivotGroup = new THREE.Group();
        pivotGroup.position.x = 0.3;
        pivotGroup.position.y = -100;
        pivotGroup.rotation.x = -0.6;
        scene.add(pivotGroup);

        const loader = new FBXLoader();

        loader.load(
            "/diamond.fbx",
            (object) => {
                object.traverse((child) => {
                    if (child instanceof THREE.Mesh) {
                        child.material = diamondMaterial;
                        child.castShadow = true;
                        child.receiveShadow = true;
                    }
                });

                object.scale.set(0.52, 0.52, 0.52);
                object.rotation.z = Math.PI;

                const box = new THREE.Box3().setFromObject(object);
                const center = box.getCenter(new THREE.Vector3());

                object.position.x = -center.x;
                object.position.y = -center.y;
                object.position.z = -center.z;

                pivotGroup.add(object);
            },
            undefined,
            (error) => {
                console.error("Error loading diamond:", error);
            },
        );

        function resize() {
            if (!canvas) return;
            const width = canvas.clientWidth;
            const height = canvas.clientHeight;
            if (width === 0 || height === 0) return;
            renderer.setSize(width, height, false);
            camera.aspect = width / height;
            camera.updateProjectionMatrix();
        }

        const ro = new ResizeObserver(resize);
        ro.observe(canvas);
        resize();

        const clock = new THREE.Clock();
        let rafId: number;

        function animate() {
            rafId = requestAnimationFrame(animate);

            const time = clock.getElapsedTime();

            pivotGroup.rotation.y = time * 0.05;
            pivotGroup.position.y = -0.1 + Math.sin(time * 0.5) * 0;

            renderer.render(scene, camera);
        }

        animate();

        window.addEventListener("beforeunload", () => {
            cancelAnimationFrame(rafId);
            ro.disconnect();
            renderer.dispose();
            pmremGenerator.dispose();
            scene.remove(pivotGroup);
            diamondMaterial.dispose();
        });
    } else {
        console.error("Canvas element [data-three-sphere] not found!");
    }
</script>
