<canvas data-three-sphere class="absolute inset-0 w-full h-full block"></canvas>

<script>
    import * as THREE from "three";
    import { FBXLoader } from "three/examples/jsm/loaders/FBXLoader.js";
    import { RoomEnvironment } from "three/examples/jsm/environments/RoomEnvironment.js";
    import { PMREMGenerator } from "three";

    const canvas = document.querySelector("[data-three-sphere]");

    if (canvas) {
        const renderer = new THREE.WebGLRenderer({
            canvas,
            antialias: true,
            alpha: true,
        });
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        renderer.toneMapping = THREE.ACESFilmicToneMapping;
        renderer.toneMappingExposure = 1.25; // Increased for brighter, more brilliant appearance

        const scene = new THREE.Scene();

        // Environment Map - Enhanced for better reflections
        const pmremGenerator = new THREE.PMREMGenerator(renderer);
        pmremGenerator.compileEquirectangularShader();
        const roomEnvironment = new RoomEnvironment();
        scene.environment = pmremGenerator.fromScene(
            roomEnvironment,
            0.02, // Lower blur for sharper reflections
        ).texture;
        roomEnvironment.dispose();

        // Camera
        const camera = new THREE.PerspectiveCamera(45, 1, 0.1, 100);
        camera.position.set(0, 0.6, 0);
        camera.lookAt(0, 0.55, 0);

        // Enhanced Lighting for Hyperrealism
        const light1 = new THREE.DirectionalLight(0xffffff, 3.0); // Increased intensity
        light1.position.set(5, 5, 5);
        scene.add(light1);

        const light2 = new THREE.DirectionalLight(0xffffff, 2.0); // Increased intensity
        light2.position.set(-5, 5, 2);
        scene.add(light2);

        // Add accent light for sparkle
        const light3 = new THREE.DirectionalLight(0xffffff, 1.5);
        light3.position.set(0, -3, 3);
        scene.add(light3);

        const ambient = new THREE.AmbientLight(0xffffff, 0.3); // Slightly increased
        scene.add(ambient);

        // Hyperrealistic Diamond Material
        const diamondMaterial = new THREE.MeshPhysicalMaterial({
            color: 0xd0f5ff, // Lighter icy blue for more brilliance
            metalness: 0, // Diamonds are dielectric, not metallic
            roughness: 0, // Perfectly smooth facets
            transmission: 1.0, // Full transparency
            thickness: 3.0, // Optimized for better light behavior
            envMapIntensity: 3.5, // Stronger reflections
            clearcoat: 1.0, // Maximum clearcoat
            clearcoatRoughness: 0, // Perfect clarity
            ior: 2.417, // Exact diamond index of refraction
            dispersion: 0.85, // Maximum fire/rainbow effect
            attenuationColor: new THREE.Color(0x0099ff), // Vibrant blue depth
            attenuationDistance: 0.8, // Faster color absorption for depth
            specularIntensity: 1.0, // Enhanced specular highlights
            specularColor: new THREE.Color(0xffffff), // Pure white highlights
            side: THREE.DoubleSide,
        });

        // Pivot Group to handle centering
        const pivotGroup = new THREE.Group();
        pivotGroup.position.x = 0.3; // Move to the right
        // Tilt the whole group so the "top" (originally up) faces somewhat forward
        pivotGroup.rotation.x = -0.5;
        scene.add(pivotGroup);

        // Load FBX
        const loader = new FBXLoader();
        // let diamondMesh = null; // No longer needed as we animate the pivotGroup

        loader.load(
            "/diamond.fbx",
            (object) => {
                object.traverse((child) => {
                    if (child.isMesh) {
                        child.material = diamondMaterial;
                        child.castShadow = true;
                        child.receiveShadow = true;
                    }
                });

                // Scale
                object.scale.set(0.5, 0.5, 0.5);

                // Flip upside down (tip pointing down)
                object.rotation.z = Math.PI;

                // Center logic:
                // 1. Calculate bounding box of the raw object
                const box = new THREE.Box3().setFromObject(object);
                const center = box.getCenter(new THREE.Vector3());

                // 2. Offset the object so its center aligns with parent (0,0,0)
                object.position.x = -center.x;
                object.position.y = -center.y;
                object.position.z = -center.z;

                // 3. Add to pivot group.
                // Now pivotGroup's origin (0,0,0) is the visual center of the diamond.
                pivotGroup.add(object);
            },
            undefined,
            (error) => {
                console.error("Error loading diamond:", error);
            },
        );

        function resize() {
            const width = canvas.clientWidth;
            const height = canvas.clientHeight;
            if (width === 0 || height === 0) return;
            renderer.setSize(width, height, false);
            camera.aspect = width / height;
            camera.updateProjectionMatrix();
        }

        const ro = new ResizeObserver(resize);
        ro.observe(canvas);
        resize();

        const clock = new THREE.Clock();
        let rafId;

        function animate() {
            rafId = requestAnimationFrame(animate);

            const time = clock.getElapsedTime();

            // Rotate the PIVOT GROUP, not the offset mesh.
            pivotGroup.rotation.y = time * 0.1;

            // Floating effect on the pivot group
            pivotGroup.position.y = Math.sin(time * 0.5) * 0;

            // pivotGroup.rotation.z = Math.sin(time * 0.3) * 0.1;

            renderer.render(scene, camera);
        }

        animate();

        window.addEventListener("beforeunload", () => {
            cancelAnimationFrame(rafId);
            ro.disconnect();
            renderer.dispose();
            pmremGenerator.dispose();
            scene.remove(pivotGroup); // Clean up group
            diamondMaterial.dispose();
        });
    } else {
        console.error("Canvas element [data-three-sphere] not found!");
    }
</script>
